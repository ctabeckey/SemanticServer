<!-- HTML5 -->
<!DOCTYPE html>
<html>
<head>
    <title>Workflow Editor</title>
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1, maximum-scale=1">
    <link rel=stylesheet type="text/css" href="/style/site.css"/>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css"/>
    <link rel="stylesheet" type="text/css" href="/style/bootstrap.min.css"/>

</head>

<body style="">
    <div id="header" style="display: block">
        Workflow Identifier: <input type="text" maxlength="32" id="workflowidentifier"/>
        <button id="load" type="button" title="Edit" onclick="loadIdentifiedWorkflow();"/>
    </div>

    <div id="cy" class="cy col-md-7 col-md-offset-1">
    </div>

    <div id="popup" class="popup">
    </div>

</body>

<!--
WARNING
cytoscape-toolbar.js works with jquery 2.1.3 and cytoscape 2.3.7, usage of
other versions has been demonstrated to fail.
 -->
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/2.3.7/cytoscape.js"></script>
<script src="/scripts/cytoscape-toolbar.js"></script>

<script>
    $(function () {
        // also get style via ajax
        var styleP = $.ajax({
            url: '/style/workflow.cytoscapestyle',
            type: 'GET',
            dataType: 'text'
        });

        // when style is loaded, initialize cytoscape
        Promise.all([styleP]).then(initCy);

        function initCy(then) {
            var styleJson = then[0];

            var cy = window.cy = cytoscape({
                container: document.getElementById('cy'),
                style: styleJson,
                motionBlur: true,
                selectionType: 'single',
                boxSelectionEnabled: false,
                layout: {
                    name: 'grid',
                    fit: false,
                    rows: 10,
                    cols: 50,
                    position: function(node) {
                        var nodeX = node._private.position.x;
                        var nodeY = node._private.position.y;

                        return {row: nodeY, col: nodeX};
                    }
                },
                ready: function (evt) {
                    cy.toolbar({
                        tools: [
                            [
                                {
                                    icon: 'fa fa-cogs',
                                    event: ['tap'],
                                    selector: 'node',
                                    bubbleToCore: false,
                                    tooltip: 'Add Business Processor',
                                    action: [addProcessorToGraph]
                                }
                            ],
                            [
                                {
                                    icon: 'fa fa-code-fork',
                                    event: ['tap'],
                                    selector: 'node',
                                    bubbleToCore: false,
                                    tooltip: 'Add Parallel Workflow',
                                    action: [addParallelWorkflowToGraph]
                                }
                            ],
                            [
                                {
                                    icon: 'fa fa-question',
                                    event: ['tap'],
                                    selector: 'node',
                                    bubbleToCore: false,
                                    tooltip: 'Add Conditional Workflow',
                                    action: [addConditionalProcessorToGraph]
                                }
                            ],
                            [
                                {
                                    icon: 'fa fa-link',
                                    event: ['tap'],
                                    selector: 'node',
                                    bubbleToCore: false,
                                    tooltip: 'Add Workflow Link',
                                    action: [addConditionalProcessorToGraph]
                                }
                            ],
                            [
                                {
                                    icon: 'fa fa-eraser',
                                    event: ['tap'],
                                    selector: 'node',
                                    bubbleToCore: false,
                                    tooltip: 'Delete Graph Items',
                                    action: [deleteGraphItems]
                                }
                            ]
                        ],
                        appendTools: false
                    });
                }
            });

            loadWorkflow('ParallelWorkflow');

            cy.on('tap', 'node', { foo: 'bar' }, function(evt){
                var node = evt.cyTarget;
                console.log( 'tapped ' + node.id() );
            });
        }
    });

    function loadIdentifiedWorkflow() {
        loadWorkflow( document.getElementById('workflowidentifier').value );
    }

    function loadWorkflow(identifier) {
        // get workflow from server via ajax
        // '/workflow/OneStepWorkflow'
        var elementsPromise = $.ajax({
            url: '/workflow/' + identifier,
            type: 'GET',
            dataType: 'json'
        });

        Promise.all([elementsPromise]).then(
            function (then) {
                var expJson = then[0];
                var elements = expJson.elements;

                // load the elements, this and the ajax call to get the elements
                // should be moved to a function, callable from an event handler.
                cy.load(elements, function () {}, function () {});
            }
        );
    }

    function addProcessorToGraph(e) {
        console.log("Adding a business processor to graph");
    }

    function addConditionalProcessorToGraph(e) {
        console.log("Adding a conditional processor to graph");
    }

    function addParallelWorkflowToGraph(e) {
        console.log("Adding a parallel workflow to graph");
    }

    function addLinkToGraph(e) {
        console.log("Adding a workflow link to graph");
    }

    function deleteGraphItems(e) {
        console.log("Deleting graph items");
    }
</script>
</html>
