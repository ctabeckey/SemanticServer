<!-- HTML5 -->
<!DOCTYPE html>
<html>
<head>
    <title>Workflow Editor</title>
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1, maximum-scale=1">
    <link rel=stylesheet type="text/css" href="/style/site.css"/>
    <link rel=stylesheet type="text/css" href="/style/jquery-ui.css"/>
    <link rel=stylesheet type="text/css" href="/style/jquery-ui.structure.css"/>
    <link rel=stylesheet type="text/css" href="/style/jquery-ui.theme.css"/>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css"/>
    <link rel="stylesheet" type="text/css" href="/style/bootstrap.min.css"/>
</head>

<body>
    <div id="header" style="display: block">
        Workflow Identifier: <input type="text" maxlength="32" id="workflowidentifier"/>
        <button id="load" type="button" title="Edit" onclick="loadIdentifiedWorkflow();"/>
    </div>

    <div id="cy" class="cy col-md-7 col-md-offset-1">
    </div>

    <div id="processor_popup" title="Processor">
        <label for="name">Name:</label>
        <input type="text" name="name" id="name" placeholder="Processor Name">

        <label for="className">Processor Class:</label>
        <input type="text" name="className" id="className" placeholder="Processor Class">

        <table>
            <tr><td>Property</td><td>Value</td></tr>
        </table>

        <input type="submit" value="Save" onclick="saveAndCloseBusinessProcessorPopup();">
    </div>
</body>

<!--
WARNING
cytoscape-toolbar.js works with jquery 2.1.3 and cytoscape 2.3.7, usage of
other versions has been demonstrated to fail.
 -->
<script type="text/javascript" src="http://code.jquery.com/jquery-2.1.4.min.js"></script>
<script type="text/javascript"  src="http://code.jquery.com/ui/1.11.4/jquery-ui.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/2.3.7/cytoscape.js"></script>
<script src="/scripts/cytoscape-toolbar.js"></script>

<script>
    $(function () {
        // also get style via ajax
        var styleP = $.ajax({
            url: '/style/workflow.cytoscapestyle',
            type: 'GET',
            dataType: 'text'
        });

        // when style is loaded, initialize cytoscape
        Promise.all([styleP]).then(initCy);

        function initCy(then) {
            var styleJson = then[0];

            var cy = window.cy = cytoscape({
                container: document.getElementById('cy'),
                style: styleJson,
                motionBlur: true,
                selectionType: 'single',
                boxSelectionEnabled: false,
                layout: {
                    name: 'grid',
                    fit: false,
                    rows: 10,
                    cols: 50,
                    position: function(node) {
                        var nodeX = node._private.position.x;
                        var nodeY = node._private.position.y;

                        return {row: nodeY, col: nodeX};
                    }
                },
                ready: function (evt) {
                    cy.toolbar({
                        tools: [
                            [
                                {
                                    icon: 'fa fa-cogs',
                                    event: ['tap'],
                                    selector: 'node',
                                    bubbleToCore: false,
                                    tooltip: 'Add Business Processor',
                                    action: [addProcessorToGraph]
                                }
                            ],
                            [
                                {
                                    icon: 'fa fa-code-fork',
                                    event: ['tap'],
                                    selector: 'node',
                                    bubbleToCore: false,
                                    tooltip: 'Add Parallel Workflow',
                                    action: [addParallelWorkflowToGraph]
                                }
                            ],
                            [
                                {
                                    icon: 'fa fa-question',
                                    event: ['tap'],
                                    selector: 'node',
                                    bubbleToCore: false,
                                    tooltip: 'Add Conditional Workflow',
                                    action: [addConditionalProcessorToGraph]
                                }
                            ],
                            [
                                {
                                    icon: 'fa fa-link',
                                    event: ['tap'],
                                    selector: 'node',
                                    bubbleToCore: false,
                                    tooltip: 'Add Workflow Link',
                                    action: [addConditionalProcessorToGraph]
                                }
                            ],
                            [
                                {
                                    icon: 'fa fa-eraser',
                                    event: ['tap'],
                                    selector: 'node',
                                    bubbleToCore: false,
                                    tooltip: 'Delete Graph Items',
                                    action: [deleteGraphItems]
                                }
                            ]
                        ],
                        appendTools: false
                    });
                }
            });

            // var j = cy.$('#j');
            console.log("Installing handlers");
            // handle right-click events on business processors
            cy.on('cxttap',
                    'node[type = "business"]',
                    { foo: 'bar' },
                    showBusinessProcessorPopup
            );

            loadWorkflow('ParallelWorkflow');

        }
    });

    function loadIdentifiedWorkflow() {
        loadWorkflow( document.getElementById('workflowidentifier').value );
    }

    function loadWorkflow(identifier) {
        // get workflow from server via ajax
        // '/workflow/OneStepWorkflow'
        var elementsPromise = $.ajax({
            url: '/workflow/' + identifier,
            type: 'GET',
            dataType: 'json'
        });

        Promise.all([elementsPromise]).then(
            function (then) {
                var expJson = then[0];
                var elements = expJson.elements;

                // load the elements, this and the ajax call to get the elements
                // should be moved to a function, callable from an event handler.
                cy.load(elements, function () {}, function () {});
            }
        );
    }

    function showBusinessProcessorPopup(evt) {
        console.log( 'Showing processor details in response to ' + evt + " on target " + evt.cyTarget);
        var node = evt.cyTarget;

        $( "#processor_popup" ).dialog();
    }

    function saveAndCloseBusinessProcessorPopup() {
        closeBusinessProcessorPopup();
    }

    function closeBusinessProcessorPopup() {
        $( "#processor_popup" ).hide();
    }

    function addProcessorToGraph(evt) {
        if (evt.cyTarget === cy) {
            return;
        }
        console.log("Adding a business processor to graph, target is " + evt.cyTarget);
    }

    function addConditionalProcessorToGraph(evt) {
        console.log("Adding a conditional processor to graph");
    }

    function addParallelWorkflowToGraph(evt) {
        console.log("Adding a parallel workflow to graph");
    }

    function addLinkToGraph(evt) {
        console.log("Adding a workflow link to graph");
    }

    function deleteGraphItems(evt) {
        console.log("Deleting graph items");
    }
</script>
</html>
